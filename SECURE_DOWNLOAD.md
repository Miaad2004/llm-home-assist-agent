# Secure File Download System

This document describes the secure file download system implemented for the Smart Home Assistant API.

## Overview

The file download system provides a secure way to download files generated by the TTS service and other components. It implements several security measures to prevent unauthorized access to system files.

## Security Features

### 1. Download Folder Restriction

- All downloadable files must be stored in a designated download folder
- The folder path is configured via `DOWNLOAD_FOLDER_PATH` environment variable
- Default location: `./downloads` (relative to project root)

### 2. Filename-Only API

- The API accepts only filenames, not full paths
- This prevents directory traversal attacks like `../../../etc/passwd`
- Files are automatically resolved within the secure download folder

### 3. Path Validation

- Filenames are validated to prevent path separators (`/`, `\`, `..`)
- Absolute path resolution ensures files stay within the download folder
- Invalid filenames return HTTP 400 error

### 4. File Type Detection

- Automatic MIME type detection based on file extensions
- Supports common audio, video, image, and document formats
- Unknown types default to `application/octet-stream`

## Configuration

### Environment Variables

Add to your `.env` file:

```bash
# File Download Configuration
DOWNLOAD_FOLDER_PATH=./downloads
```

### Settings

The download folder path is configured in `config/settings.py`:

```python
DOWNLOAD_FOLDER_PATH = os.getenv("DOWNLOAD_FOLDER_PATH",
    os.path.join(os.path.dirname(__file__), '..', 'downloads'))
```

## API Endpoints

### Download File

```
GET /files/download?filename={filename}
```

**Parameters:**

- `filename` (required): Name of the file to download (filename only, no paths)

**Response:**

- Success: File content with appropriate `Content-Type` header
- Error 400: Invalid filename (contains path separators)
- Error 403: File outside download folder (security violation)
- Error 404: File not found
- Error 500: Server error

**Example:**

```bash
curl "http://localhost:8000/files/download?filename=tts_output_abc123.wav"
```

## TTS Integration

The TTS service has been updated to work with the secure download system:

### TTS Synthesis Endpoint

```
POST /tts/synthesize
```

**Response:**

```json
{
  "message": "TTS synthesis completed for: 'Hello world'",
  "voice": "default",
  "audio_filename": "tts_output_abc123.wav",
  "download_url": "/files/download?filename=tts_output_abc123.wav",
  "status": "success"
}
```

### TTS File Download Endpoint

```
POST /tts/synthesize/file
```

**Response:** Direct file download (unchanged behavior)

## Frontend Integration

### JavaScript Example

```javascript
// Download a file by filename
async function downloadFile(filename) {
  try {
    const response = await fetch(
      `${API_BASE}/files/download?filename=${encodeURIComponent(filename)}`
    );

    if (response.ok) {
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      window.URL.revokeObjectURL(url);
    } else {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
  } catch (error) {
    console.error("Download failed:", error);
  }
}

// Download TTS file after synthesis
async function synthesizeAndDownload(text) {
  const response = await fetch(`${API_BASE}/tts/synthesize`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ text, voice: "default" }),
  });

  const data = await response.json();
  if (data.audio_filename) {
    await downloadFile(data.audio_filename);
  }
}
```

## File Management

### Supported File Types

| Extension  | MIME Type                |
| ---------- | ------------------------ |
| .wav       | audio/wav                |
| .mp3       | audio/mpeg               |
| .mp4       | video/mp4                |
| .txt       | text/plain               |
| .json      | application/json         |
| .pdf       | application/pdf          |
| .png       | image/png                |
| .jpg/.jpeg | image/jpeg               |
| (others)   | application/octet-stream |

### File Cleanup

The system does not automatically clean up old files. Consider implementing:

- Periodic cleanup of old TTS files
- File expiration based on creation time
- Maximum file count limits per user/session

## Security Considerations

### What's Protected âœ…

- Directory traversal attacks (`../`, `..\\`)
- Absolute path access (`/etc/passwd`, `C:\\Windows\\system32`)
- Access to files outside the download folder
- Path normalization attacks

### Additional Recommendations ðŸ”’

- Implement file access logging
- Add rate limiting for download endpoints
- Consider user-based file isolation
- Implement file size limits
- Add virus scanning for uploaded files

## Testing

Run the security test suite:

```bash
python examples/test_secure_download.py
```

This tests:

- Valid file downloads
- Path traversal prevention
- Non-existent file handling
- TTS integration

## Migration Notes

### Breaking Changes

- File download API now uses `filename` parameter instead of `file_path`
- TTS response now includes `audio_filename` instead of `audio_file_path`
- Files must be in the designated download folder

### Frontend Updates Required

- Update download function to use filename parameter
- Update TTS integration to use new response format
- Update user interfaces to show filenames instead of paths
